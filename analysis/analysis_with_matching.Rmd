---
title: "Graphs Figure"
author: "Joshua G. Mausolf"
date: "3/9/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
######################################
## Load Libraries & Data
######################################


library(Rmisc)
library(Hmisc)
library(tidyverse)
library(bbplot)
library(scales)
library(RColorBrewer)
library(ggthemes)


colors_neutral = rev(brewer.pal(n = 8, name = "Purples")[5:8])
colors_dem = rev(brewer.pal(n = 8, name = "Blues")[5:8])
colors_rep = c("#700009", "#99000D", "#D80012", "#EF3B2C")

colors_grey = rev(brewer.pal(n = 8, name = "Greys")[5:8])
show_col(colors_grey)

colors_parties6= c("#2129B0", "#969696", "#BF1200", "#BF1200", "#969696", "#2129B0")
colors_parties2 = c("#2129B0", "#969696", "#BF1200")
colors_parties1 = c(colors_dem[1], colors_neutral[1], colors_rep[1])
colors_parties0 = c("#2129B0", "#3A084A", "#BF1200")
show_col(colors_parties0)

#Display a Pallete
show_col(colors_dem)

#Overwrite bbplot finalise_plot() function
source("bb_finalise_plot_academic.R")

source("analysis_source.R")
######################################
## Load Data
######################################

#source file and cleaning

dfec_edit <- dfec %>% 
  mutate(pm_var = pmXf) 
  #filter(matched_pair == "A") %>% 
  #filter(version == "B") 
  #filter(pair_callback_bin != 2) %>%
  #TODO more qc on results, get more results
```



```{r}

df1 <- dfec_edit %>%
  #filter(pair_callback_bin != 2) %>%
  select(callback_binary, pm_var, partyX) %>%
  group_by(pm_var, partyX) %>%
  add_tally(callback_binary, name = "total_callbacks") %>%
  add_count(pm_var, name = "total_applications") %>%
  mutate(proportion_callback = total_callbacks / total_applications) %>%
  select(-callback_binary) %>%
  distinct()


df1_err <- binconf(df1$total_callbacks, df1$total_applications, alpha=0.05, method=c("asymptotic"))
df1_err <- as.data.frame(df1_err) %>% 
  mutate(pe = PointEst, 
         lci = Lower,
         uci = Upper) %>% 
  select(pe, lci, uci) 

  
party_matches <- c("mismatch", "neutral", "match")
parties <- c("DEM", "REP")

#Add ttest upper, lower ci (one-sided)
party_matches <- c("mismatch", "neutral", "match")
parties <- c("DEM", "REP")

output <- list()
for(i in seq_along(parties)){
  for(j in seq_along(party_matches)){
    p = parties[i]
    pm = party_matches[j]
    id <- paste(p, pm, sep = '_')
    ttd <- dfec %>% select(callback_binary, partyX, pmXf) %>% filter(pmXf == pm, partyX == p)
    tt <- t.test(ttd$callback_binary)
    li <- tt$conf.int[1]
    ui <- tt$conf.int[2]

    tt1 <- t.test(ttd$callback_binary, alternative = "greater")
    li1 <- tt1$conf.int[1]
    
    tt2 <- t.test(ttd$callback_binary, alternative = "less")
    ui2 <- tt2$conf.int[2]
    mean <- tt$estimate[1]
    
    df_out <- data.frame(p, pm, mean, li, ui, li1, ui2)
    output[[id]] <- df_out
}
}



dft <- bind_rows(output) 


df1_full <- bind_cols(df1, df1_err) %>% arrange(partyX, pm_var)
df1_full <- bind_cols(df1_full, dft)

df1_full <- df1_full %>% 
  #Make Special Column for Graph
  mutate(pm_var_party = str_c(pm_var, partyX, sep = '_')) 

#Must run ttest_loop_matrics
df1_full <- left_join(df1_full, pvals_df_firm) %>% 
#df1_full <- df1_full %>% 
  mutate(pm_var_party = factor(pm_var_party,
                               levels = c("match_DEM", "neutral_DEM", "match_REP",
                                          "mismatch_DEM", "neutral_REP", "mismatch_REP"),
                               )) %>%
  select(pm_var_party, pm_var, partyX, everything())

table(df1_full$pm_var_party)
```


```{r}
#colors_parties6= c("#2129B0", "#BF1200", "#BF1200", "#2129B0", "#969696", "#969696")
#X, neu, X, mismatch dem, neu, mismatch rep
colors_parties6= c("#2129B0", "#969696", "#BF1200", "#BF1200", "#969696", "#2129B0")

party_types <- c(
  "DEM" = "Democratic Firm",
  "REP" = "Republican Firm"
)

make_bar_app_match_party <- function(df_in){

  g <- ggplot(df_in, aes(pm_var, proportion_callback, fill=pm_var_party)) +
  # ggplot(df1_full, aes(pm_var, proportion_callback, fill=pm_var_party)) +
    geom_bar(stat = "identity") +
    geom_errorbar(aes(ymin=li, ymax=ui), width=0.4) + 
    facet_grid(~partyX, labeller = as_labeller(party_types)) +
    
    #Add bbcstyle
    bbc_style() +
    
    scale_y_continuous(labels = scales::percent)  +
    
    #scale_fill_manual("", values=colors_parties6) +
    
    #Xaxis Line
    geom_hline(yintercept = 0, size = 1, colour="#333333") +
    
    #Add axis titles
    theme(axis.title = element_text(size = 18)) +
    xlab("Applicant Partisanship") +
    ylab("Percentage Callbacks") +
    labs(title = "Callbacks by Applicant and Firm Party",
         caption = "") +
    theme(plot.title = element_text(hjust = 0.5)) +
    

    #Add x axis ticks
    theme(
      #Remove X axis
      #axis.title.x=element_blank(),
      axis.ticks.x = element_blank(),
      axis.text.x = element_blank()) +
      #axis.text = element_text(size=14, color="#222222")) +
      
    
    theme(
      #Blank Background
      panel.background = ggplot2::element_blank(),
      
      #Grid lines
      panel.grid.minor = ggplot2::element_blank(),
      panel.grid.major.y = ggplot2::element_line(color="#cbcbcb"),
      panel.grid.major.x = ggplot2::element_blank(),
      
      #Facet Wrap Background
      strip.background = ggplot2::element_rect(fill="white"),
      strip.text = ggplot2::element_text(size  = 18,  hjust = 0.5),
      
      #Axis Text
      axis.text = ggplot2::element_text(size=14,
                                        color="#222222")
    ) +
    
    #Legend Text and Fill
    scale_fill_manual(name="",
                      breaks=c("match_DEM", "neutral_REP", "match_REP"),
                      labels=c("Democrat", "Neutral", "Republican"),
                      values=colors_parties6) +
    
    #Adjust Legend Position
    theme(
      legend.position = 'bottom',
      #legend.justification='right',
      legend.direction='horizontal',
      legend.spacing.x = unit(3.5, 'mm'),
      #legend.position=c(0.0,.9)
      legend.text=element_text(size=16)
    ) +

    #Add text, star labels    
    geom_text(aes(label = star_range, y = ui), vjust = -0.25) 

  #guides(shape = guide_legend(override.aes = list(fill = colors_parties2)))

  finalise_plot(g, "", "output/plots/bar_partisan_match_X_firm_party.png", footer=FALSE)
  return(g)

}

make_bar_app_match_party(df1_full)


```



```{r}
df2 <- dfec_edit %>% 
  #filter(pair_callback_bin != 2) %>% 
  select(callback_binary, pm_var, party) %>% 
  group_by(pm_var, party) %>% 
  add_tally(callback_binary, name = "total_callbacks") %>% 
  add_count(pm_var, name = "total_applications") %>% 
  mutate(proportion_callback = total_callbacks / total_applications) %>% 
  select(-callback_binary) %>% 
  distinct()

df2

#Get Upper and Lower CI
df2_err <- binconf(df2$total_callbacks, df2$total_applications, alpha=0.05, method=c("asymptotic"))
df2_err <- as.data.frame(df2_err) %>% 
  mutate(pe = PointEst, 
         lci = Lower,
         uci = Upper) %>% 
  select(pe, lci, uci)
df2_full <- bind_cols(df2, df2_err)



party_types <- c(
  "DEM" = "Democrat",
  "NEU" = "Neutral",
  "REP" = "Republican"
)


make_bar_app_match_party <- function(df_in){
  
  g <- ggplot(df_in, aes(pm_var, proportion_callback, fill=pm_var)) +
    geom_bar(stat = "identity") +
    geom_errorbar(aes(ymin=lci, ymax=uci), width=0.4) + 
    facet_grid(~party, labeller = as_labeller(party_types)) +
    
    #Add bbcstyle
    bbc_style() +
    
    scale_y_continuous(labels = scales::percent)  +
    
    scale_fill_manual("", values=colors_parties2) +
    
    #Xaxis Line
    geom_hline(yintercept = 0, size = 1, colour="#333333") +
    
    #Add axis titles
    theme(axis.title = element_text(size = 18)) +
    xlab("Applicant Partisan Match") +
    ylab("Percentage Callbacks") +
    labs(title = "Callbacks by Applicant Party and Partisan Match",
         caption = "") +
    theme(plot.title = element_text(hjust = 0.5)) +
    
    
    #Add x axis ticks
    theme(
      axis.ticks.x = element_line(colour = "#333333"), 
      axis.ticks.length =  unit(0.26, "cm"),
      axis.text = element_text(size=14, color="#222222")) +
    
    theme(
      #Blank Background
      panel.background = ggplot2::element_blank(),
      
      #Grid lines
      panel.grid.minor = ggplot2::element_blank(),
      panel.grid.major.y = ggplot2::element_line(color="#cbcbcb"),
      panel.grid.major.x = ggplot2::element_blank(),
      
      #Facet Wrap Background
      strip.background = ggplot2::element_rect(fill="white"),
      strip.text = ggplot2::element_text(size  = 18,  hjust = 0.5),
      
      #Axis Text
      axis.text = ggplot2::element_text(size=14,
                                        color="#222222")
    ) +
    
    #Remove Legend
    theme(legend.position = "none")
  #guides(shape = guide_legend(override.aes = list(fill = colors_parties2)))
  
  finalise_plot(g, "", "output/plots/test_bar_partisan_match_X_party_new.png", footer=FALSE)
  return(g)
  
}

make_bar_app_match_party(df2_full)


```




```{r}
df3 <- dfec_edit %>% 
  #filter(pair_callback_bin != 2) %>% 
  select(callback_binary, pm_var) %>% 
  group_by(pm_var) %>% 
  add_tally(callback_binary, name = "total_callbacks") %>% 
  add_count(pm_var, name = "total_applications") %>% 
  mutate(proportion_callback = total_callbacks / total_applications) %>% 
  select(-callback_binary) %>% 
  distinct()


df3

#Get Upper and Lower CI
df3_err <- binconf(df3$total_callbacks, df3$total_applications, alpha=0.05, method=c("asymptotic"))
df3_err <- as.data.frame(df3_err) %>% 
  mutate(pe = PointEst, 
         lci = Lower,
         uci = Upper) %>% 
  select(pe, lci, uci)
df3_full <- bind_cols(df3, df3_err)


party_types <- c(
  "DEM" = "Democrat",
  "NEU" = "Neutral",
  "REP" = "Republican"
)


make_bar_app_match_only <- function(df_in){
  
  g <- ggplot(df_in, aes(pm_var, proportion_callback, fill=pm_var)) +
    geom_bar(stat = "identity") +
    geom_errorbar(aes(ymin=lci, ymax=uci), width=0.4) + 
    #facet_grid(~party, labeller = as_labeller(party_types)) +
    
    #Add bbcstyle
    bbc_style() +
    
    scale_y_continuous(labels = scales::percent)  +
    
    scale_fill_manual("", values=colors_grey) +
    
    #Xaxis Line
    geom_hline(yintercept = 0, size = 1, colour="#333333") +
    
    #Add axis titles
    theme(axis.title = element_text(size = 18)) +
    xlab("Applicant Partisan Match") +
    ylab("Percentage Callbacks") +
    labs(title = "Callbacks by Applicant Party and Partisan Match",
         caption = "") +
    theme(plot.title = element_text(hjust = 0.5)) +
    
    
    #Add x axis ticks
    theme(
      axis.ticks.x = element_line(colour = "#333333"), 
      axis.ticks.length =  unit(0.26, "cm"),
      axis.text = element_text(size=14, color="#222222")) +
    
    theme(
      #Blank Background
      panel.background = ggplot2::element_blank(),
      
      #Grid lines
      panel.grid.minor = ggplot2::element_blank(),
      panel.grid.major.y = ggplot2::element_line(color="#cbcbcb"),
      panel.grid.major.x = ggplot2::element_blank(),
      
      #Facet Wrap Background
      strip.background = ggplot2::element_rect(fill="white"),
      strip.text = ggplot2::element_text(size  = 18,  hjust = 0.5),
      
      #Axis Text
      axis.text = ggplot2::element_text(size=14,
                                        color="#222222")
    ) +
    
    #Remove Legend
    theme(legend.position = "none")
  #guides(shape = guide_legend(override.aes = list(fill = colors_parties2)))
  
  finalise_plot(g, "", "output/plots/test_bar_partisan_match_only_new.png", footer=FALSE)
  return(g)
  
}

make_bar_app_match_only(df3_full)



```

